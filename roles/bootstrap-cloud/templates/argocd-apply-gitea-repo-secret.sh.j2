#!/bin/bash
# Get gitea ingress host address
GITEA_INGRESS_HOST=$({{ bin_dir }}/kubectl get ingress {{ GITEA_APP_NAME }}-ingress -n {{ gitea_namespace }} -o jsonpath="{.spec.rules[0].host}")

# Set Env (for NodePort)
REPO_URL=https://$GITEA_INGRESS_HOST/root/{{ REPO_NAME }}.git
USERNAME={{ GITEA_USER }}
PASSWORD={{ GITEA_PASSWORD }}
SECRET_MANIFEST="argocd-repo-secret.yml"

# Generate repository secret
SECRET_NAME=`python3 argocd-gen-secret-name.py $REPO_URL`

# Encode base64
BASE64_REPO_URL=$(echo $(echo -n $REPO_URL | base64) | tr -d ' ')
BASE64_USERNAME=$(echo $(echo -n $USERNAME | base64) | tr -d ' ')
BASE64_PASSWORD=$(echo $(echo -n $PASSWORD | base64) | tr -d ' ')

# Get gitea tls key in ingress nginx tls secret
GITEA_TLS_CRT=$({{ bin_dir }}/kubectl get secret {{ ingress_nginx_tls }} -n {{ ingress_nginx_namespace }} -o jsonpath="{.data.tls\\.crt}")

# Replace vars
sed -i "s|\@secret_name|${SECRET_NAME}|g" ${SECRET_MANIFEST}
sed -i "s|\@repo_url|${BASE64_REPO_URL}|g" ${SECRET_MANIFEST}
sed -i "s|\@username|${BASE64_USERNAME}|g" ${SECRET_MANIFEST}
sed -i "s|\@password|${BASE64_PASSWORD}|g" ${SECRET_MANIFEST}
sed -i "s|\@tls_client_cert_key|${GITEA_TLS_CRT}|g" ${SECRET_MANIFEST}

# Create Secret
{{ bin_dir }}/kubectl apply -f $SECRET_MANIFEST
